<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Favelas – Produits</title>
  <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="produit.css">
</head>
<body>
  <header>
    <div class="brand">FAVELAS</div>
    <div class="sub">Voici nos produits disponibles ! Livraison partout dans l'Ile.</div>
  </header>

  <main class="shell">
    <!-- Grid -->
    <div id="grid" class="grid"></div>
    <div id="emptyState" class="empty" style="display:none">Rien à afficher.</div>
  </main>

  <!-- Modal -->
  <div class="modal-wrap" id="modalWrap" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-head">
        <div class="modal-title" id="modalTitle">Détails du produit</div>
        <button class="x" id="closeModal">✕</button>
      </div>
      <div class="modal-body">
        <div class="big"><img id="modalImg" alt="" /></div>
        <div>
          <div class="title" id="modalName"></div>
          <div class="price" id="modalPrice"></div>
          <div class="meta" id="modalMeta"></div>

          <div class="field">
            <div class="label">Tailles disponibles</div>
            <div class="sizes" id="sizeChips"></div>
          </div>

          <div class="field">
            <div class="label">Couleurs</div>
            <div class="swatches" id="modalSwatches"></div>
          </div>

          <div class="field">
            <div class="label">Quantité</div>
            <div class="qty">
              <input id="qty" type="number" min="1" value="1" />
              <span class="note">Pour devis/collab, clique sur “Demander”.</span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn" id="askQuote">Demander un devis</button>
        <button class="btn primary" id="addFav">Ajouter aux favoris</button>
      </div>
    </div>
  </div>

  <script>
    // --- Données Produits (4 produits, plusieurs images par produit)
    const PRODUCTS = [
      {
        id:"ts-001", name:"T-shirt Favelas", category:"tshirt", price:20.0,
        colors:["noir","blanc","violet"], sizes:["S","M","L","XL"],
        imgs:[
          "images/tshirt-noir.png",   // noir (mets ton fichier local si tu l'as, sinon laisse Unsplash)
          "images/tshirt-blanc.png",  // blanc
          "images/tshirt-violet.png"  // violet
        ]
      },
      {
        id:"bn-001", name:"Bonnet Favelas", category:"bonnet", price:20.0,
        colors:["noir","jaune","orange","gris"],
        sizes:[], // pas de tailles pour les bonnets
        imgs:[
          "images/bonnetnoire.png",   // noir
          "images/bonnetjaune.png",   // jaune
          "images/bonnetorange.png",  // orange
          "images/bonnetgris.png"     // gris
        ]
      },
      {
        id:"vs-001", name:"Veste Favelas", category:"veste", price:30.0,
        colors:["bleu","orange"], sizes:["M","L","XL"],
        imgs:[
          "images/vesteBleu.png",     // bleu
          "images/vesteOrange.png"    // orange
        ]
      },
      {
        id:"en-001", name:"Ensemble Favelas", category:"ensemble", price:35.0,
        colors:["bleu","violet"], sizes:["M","L","XL"],
        imgs:[
          "images/ensembleBleu.png",   // bleu
          "images/ensembleViolet.png"  // violet
        ]
      }
    ];

    // --- Utilitaires
    const fmt = n => new Intl.NumberFormat("fr-FR",{style:"currency",currency:"EUR"}).format(n);
    const clamp = (n,min,max)=> Math.max(min, Math.min(max,n));

    // --- État
    let favorites = new Set(JSON.parse(localStorage.getItem("fav:products") || "[]"));
    let modalState = { id:null, size:null, color:null, imgIndex:0 };
    const galleryIndex = {}; // {productId: currentImgIndex}

    // --- Sélecteurs
    const grid = document.getElementById("grid");
    const emptyState = document.getElementById("emptyState");

    // Modal
    const modalWrap = document.getElementById("modalWrap");
    const closeModal = document.getElementById("closeModal");
    const modalImg = document.getElementById("modalImg");
    const modalName = document.getElementById("modalName");
    const modalPrice = document.getElementById("modalPrice");
    const modalMeta = document.getElementById("modalMeta");
    const sizeChips = document.getElementById("sizeChips");
    const modalSwatches = document.getElementById("modalSwatches");
    const qty = document.getElementById("qty");
    const askQuote = document.getElementById("askQuote");
    const addFav = document.getElementById("addFav");

    function labelForCat(cat){
      if(cat==="tshirt") return "T-shirt";
      if(cat==="bonnet") return "Bonnet";
      if(cat==="veste")  return "Veste";
      if(cat==="ensemble") return "Ensemble";
      return "Produit";
    }
    function colorToHex(c){
      const map={
        noir:"#111", blanc:"#fff", bleu:"#2f6bff", violet:"#8a53ff",
        vert:"#39d98a", jaune:"#ffd447", orange:"#ff7a29", gris:"#9aa0a6"
      };
      return map[c] || "#888";
    }

    // --- Template carte (avec cœur dans l'image)
    function cardTemplate(p){
      const isFav = favorites.has(p.id);
      const idx = galleryIndex[p.id] ?? 0;
      const hasSizes = Array.isArray(p.sizes) && p.sizes.length > 0;

      const colorDots = (p.colors||[]).map((c,i) =>
        `<span class="sw" data-idx="${i}" title="${c}" style="background:${colorToHex(c)}"></span>`
      ).join("");

      return `
        <article class="card" data-id="${p.id}" data-category="${p.category}" data-price="${p.price}">
          <div class="thumb" data-id="${p.id}">
            <img src="${p.imgs[idx]}" alt="${p.name}" loading="lazy" />
            <span class="badge">${labelForCat(p.category)}</span>
            <button class="heart ${isFav ? "active" : ""}" data-id="${p.id}" aria-label="${isFav ? "Retirer des favoris" : "Ajouter aux favoris"}" title="${isFav ? "Retirer des favoris" : "Ajouter aux favoris"}">♥</button>
          </div>
          <div class="body">
            <div class="title">${p.name}</div>
            <div class="price">${fmt(p.price)}</div>
            <div class="swatches">${colorDots}</div>
            ${hasSizes ? `<div class="meta">Tailles: ${p.sizes.join(" · ")}</div>` : ``}
            <div class="actions">
              <button class="btn open">Détails</button>
            </div>
          </div>
        </article>
      `;
    }

    // --- Rendu de la grille
    function render(){
      const list = [...PRODUCTS];

      grid.innerHTML = list.map(cardTemplate).join("");
      emptyState.style.display = list.length ? "none" : "block";

      // Ouvrir modal
      grid.querySelectorAll(".open").forEach(btn=>{
        btn.addEventListener("click", (e)=>{
          const card = e.target.closest(".card");
          openModal(card.dataset.id);
        });
      });

      // Cœur favoris (overlay)
      grid.querySelectorAll(".heart").forEach(btn=>{
        btn.addEventListener("click", (e)=>{
          e.stopPropagation(); // ne pas déclencher le changement d’image
          const id = btn.dataset.id;
          toggleFav(id);
          btn.classList.toggle("active", favorites.has(id));
          btn.setAttribute("aria-label", favorites.has(id) ? "Retirer des favoris" : "Ajouter aux favoris");
          btn.title = favorites.has(id) ? "Retirer des favoris" : "Ajouter aux favoris";
        });
      });

      // Pastilles couleur → change l’image affichée
      grid.querySelectorAll(".card").forEach(card=>{
        const id = card.dataset.id;
        const thumb = card.querySelector(".thumb");
        const img = thumb.querySelector("img");
        card.querySelectorAll(".swatches .sw").forEach(sw=>{
          sw.addEventListener("click", (e)=>{
            const i = Number(sw.dataset.idx);
            galleryIndex[id] = i;
            const p = PRODUCTS.find(x=>x.id===id);
            img.src = p.imgs[i] || p.imgs[0];
          });
        });
      });

      // Navigation d'image: clic gauche/droit + molette + swipe
      grid.querySelectorAll(".thumb").forEach(thumb=>{
        const id = thumb.dataset.id;
        let startX = null;

        function show(idx){
          const p = PRODUCTS.find(x=>x.id===id);
          if(!p) return;
          const newIdx = clamp(idx, 0, p.imgs.length-1);
          galleryIndex[id] = newIdx;
          const img = thumb.querySelector("img");
          img.src = p.imgs[newIdx];
        }

        thumb.addEventListener("click", (e)=>{
          if(e.target.closest(".heart")) return; // clic sur le cœur = pas de slide
          const rect = thumb.getBoundingClientRect();
          const half = rect.left + rect.width/2;
          const p = PRODUCTS.find(x=>x.id===id);
          const curr = galleryIndex[id] ?? 0;
          if(!p) return;
          show(e.clientX < half ? curr - 1 : curr + 1);
        }, {passive:true});

        thumb.addEventListener("wheel", (e)=>{
          e.preventDefault();
          const p = PRODUCTS.find(x=>x.id===id);
          if(!p) return;
          const curr = galleryIndex[id] ?? 0;
          show(e.deltaY > 0 ? curr + 1 : curr - 1);
        }, {passive:false});

        thumb.addEventListener("touchstart", (e)=>{
          startX = e.touches[0].clientX;
        }, {passive:true});
        thumb.addEventListener("touchend", (e)=>{
          if(startX===null) return;
          const endX = e.changedTouches[0].clientX;
          const dx = endX - startX;
          const p = PRODUCTS.find(x=>x.id===id);
          const curr = galleryIndex[id] ?? 0;
          if(!p) return;
          if(Math.abs(dx) > 30){
            show(dx < 0 ? curr + 1 : curr - 1);
          }
          startX = null;
        }, {passive:true});
      });
    }

    // --- Favoris
    function toggleFav(id){
      if(favorites.has(id)) favorites.delete(id); else favorites.add(id);
      localStorage.setItem("fav:products", JSON.stringify(Array.from(favorites)));
    }

    // --- Modal
    function openModal(id){
      const p = PRODUCTS.find(x=>x.id===id);
      if(!p) return;
      const currentIdx = galleryIndex[id] ?? 0;
      const hasSizes = Array.isArray(p.sizes) && p.sizes.length > 0;

      modalState = {
        id: p.id,
        size: hasSizes ? (p.sizes[0] || null) : null,
        color: p.colors[currentIdx] || p.colors[0] || null,
        imgIndex: currentIdx
      };

      modalImg.src = p.imgs[currentIdx];
      modalName.textContent = p.name;
      modalPrice.textContent = fmt(p.price);
      modalMeta.textContent = `${labelForCat(p.category)} · Couleurs: ${p.colors.join(" / ")}`;

      // Champ "Tailles disponibles"
      const sizeField = sizeChips.parentElement; // le <div class="field"> parent
      if(!hasSizes){
        sizeField.style.display = "none";
        sizeChips.innerHTML = "";
      }else{
        sizeField.style.display = "";
        sizeChips.innerHTML = p.sizes.map(s => `<button class="chip ${s===modalState.size?"active":""}" data-size="${s}">${s}</button>`).join("");
        sizeChips.querySelectorAll(".chip").forEach(ch=>{
          ch.addEventListener("click", ()=>{
            sizeChips.querySelectorAll(".chip").forEach(c=>c.classList.remove("active"));
            ch.classList.add("active");
            modalState.size = ch.dataset.size;
          });
        });
      }

      // Pastilles couleur (changent l'image)
      modalSwatches.innerHTML = p.colors.map((c,i) => `
        <span class="sw" data-idx="${i}" data-color="${c}" title="${c}"
              style="width:22px;height:22px;cursor:pointer;background:${colorToHex(c)};border:2px solid #ffffff44"></span>
      `).join("");
      modalSwatches.querySelectorAll(".sw").forEach(sw=>{
        sw.addEventListener("click", ()=>{
          modalSwatches.querySelectorAll(".sw").forEach(s=>s.style.outline="1px solid #0000");
          sw.style.outline="2px solid #fff8";
          const i = Number(sw.dataset.idx);
          modalState.color = sw.dataset.color;
          modalState.imgIndex = i;
          modalImg.src = p.imgs[i] || p.imgs[0];
        });
      });

      // Sélection visuelle de la couleur courante
      const currentSw = modalSwatches.querySelector(`.sw[data-idx="${currentIdx}"]`) || modalSwatches.querySelector(".sw");
      if(currentSw){ currentSw.click(); }

      qty.value = 1;
      modalWrap.style.display = "grid";
      modalWrap.setAttribute("aria-hidden","false");
    }

    function close(){
      modalWrap.style.display = "none";
      modalWrap.setAttribute("aria-hidden","true");
    }
    closeModal.addEventListener("click", close);
    modalWrap.addEventListener("click", (e)=>{ if(e.target===modalWrap) close(); });

    askQuote.addEventListener("click", ()=>{
      const p = PRODUCTS.find(x=>x.id===modalState.id);
      const q = Number(qty.value||1);

      const parts = [];
      if (modalState.size) parts.push(modalState.size);
      if (modalState.color) parts.push(modalState.color);

      const subject = encodeURIComponent(`Devis ${p.name}${parts.length ? ` (${parts.join(', ')})` : ''} x${q}`);

      let body = `Bonjour,\n\nJe souhaite un devis pour:\n- Produit: ${p.name}`;
      if (modalState.color) body += `\n- Couleur: ${modalState.color}`;
      if (modalState.size)  body += `\n- Taille: ${modalState.size}`;
      body += `\n- Quantité: ${q}\n\nMarque: FAVELAS\nMerci !`;

      window.location.href = `mailto:contact@favelas.brand?subject=${subject}&body=${encodeURIComponent(body)}`;
    });

    addFav.addEventListener("click", ()=>{
      if(!modalState.id) return;
      toggleFav(modalState.id);
      addFav.textContent = favorites.has(modalState.id) ? "Ajouté ✓" : "Ajouter aux favoris";
      setTimeout(()=>{ addFav.textContent = "Ajouter aux favoris"; }, 1200);
      render(); // rafraîchit l’état des cœurs sur les cartes
    });

    // --- Init
    render();
  </script>
</body>
</html>
