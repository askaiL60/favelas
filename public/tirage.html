<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Roue de tirage</title>
  <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap" rel="stylesheet" />
  <style>
    /* ====== Layout & fond animé ====== */
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 20px;
      position: relative;
      min-height: 100vh;
      overflow-x: hidden;
    }
    /* Dégradé animé plein écran */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      z-index: -3;
      background: linear-gradient(120deg,
        #0f2027, #203a43, #2c5364, #3b2667, #bc4e9c);
      background-size: 300% 300%;
      animation: gradientShift 20s ease infinite;
    }
    /* Vignettage léger pour la profondeur */
    body::after {
      content: "";
      position: fixed;
      inset: 0;
      z-index: -2;
      pointer-events: none;
      background:
        radial-gradient(80% 60% at 50% 40%, rgba(0,0,0,0) 60%, rgba(0,0,0,0.25) 100%);
    }
    @keyframes gradientShift {
      0%   { background-position:   0% 50%; }
      50%  { background-position: 100% 50%; }
      100% { background-position:   0% 50%; }
    }

    /* ====== Particules & Confettis (canvases plein écran) ====== */
    #bg-particles,
    #confetti{
      position: fixed;
      inset: 0;
      pointer-events: none;
      background: transparent !important;
      border: none !important;
      border-radius: 0 !important;
      box-shadow: none !important;
    }
    #bg-particles{ z-index: -1; }   /* fond étoilé */
    #confetti{ z-index: 0; }        /* DERRIÈRE la roue */

    /* ====== Zone roue ====== */
    #wheel-container {
      position: relative;
      display: inline-block;
      margin-top: 30px;
      z-index: 2; /* au-dessus des confettis */
    }
    /* Halo/vague animée derrière la roue */
    #wheel-container::before{
      content:"";
      position:absolute;
      inset:-60px;
      border-radius:50%;
      z-index:-1;
      background:
        radial-gradient(45% 45% at 50% 50%, rgba(255,255,255,0.15), rgba(255,255,255,0) 60%),
        radial-gradient(60% 60% at 60% 40%, rgba(0,0,0,0.22), rgba(0,0,0,0) 60%);
      filter: blur(18px);
      animation: waveFloat 8s ease-in-out infinite;
    }
    @keyframes waveFloat {
      0%,100% { transform: scale(1) translateY(0); opacity: 0.9; }
      50%     { transform: scale(1.04) translateY(6px); opacity: 1; }
    }

    /* Flèche au-dessus de la roue */
    #arrow-container {
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
    }
    .arrow-border {
      position: absolute;
      width: 0; height: 0;
      border-left: 14px solid transparent;
      border-right: 15.5px solid transparent;
      border-top: 59px solid black;
    }
    .arrow-core {
      position: absolute;
      top: 4px;
      left: 2px;
      width: 0; height: 0;
      border-left: 12px solid transparent;
      border-right: 12px solid transparent;
      border-top: 50px solid red;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4));
    }

    /* La roue uniquement (ne pas cibler tous les canvas) */
    #wheel {
      border: 5px solid #333;
      border-radius: 50%;
      background-color: #fff;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    /* Logo centre */
    #logo-center {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 80px;
      height: 80px;
      transform: translate(-50%, -50%);
      border-radius: 50%;
      background-repeat: no-repeat;
      background-color: #000;
      background-image: url('images/favelas.png'); /* mets ton chemin */
      background-size: 90px;
      background-position: center;
      border: 3px solid #333;
      z-index: 5;
    }

    /* ====== Typo & UI ====== */
    h2, h3 { color: #ffffff; }
    /* on place ces éléments au-dessus de la roue/confettis */
    h2, h3, #winner, #spinBtn {
      position: relative;
      z-index: 3;
    }

    button {
      margin-top: 30px;
      padding: 12px 25px;
      font-size: 16px;
      font-weight: bold;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 8px 24px rgba(0,0,0,0.35);
    }
    button:hover { background-color: #0056b3; }

    /* Liste des gagnants : carte propre */
#winner {
  margin: 20px auto;         /* centre le bloc */
  font-size: 18px;
  font-family: Arial, sans-serif;
  text-align: center;        /* centre le texte */
  max-width: 500px;          /* limite la largeur pour pas trop s’étaler */

  background: rgba(0, 0, 0, 0.6);
  color: #fff;
  padding: 15px 20px;
  border-radius: 12px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  transition: all 0.3s ease;
}

#winner b {
  color: #FFD700;
}

#winner p {
  margin: 8px 0;
}


    /* === Étape 2: Vibration courte de la roue (anticipation avant l'arrêt) === */
    @keyframes wheelShake {
      0%,100% { transform: translateX(0) rotate(0deg); }
      20%     { transform: translateX(-2px) rotate(-0.4deg); }
      40%     { transform: translateX(2px)  rotate(0.4deg); }
      60%     { transform: translateX(-1.5px) rotate(-0.3deg); }
      80%     { transform: translateX(1.5px)  rotate(0.3deg); }
    }
    #wheel.shake { animation: wheelShake 0.8s ease; }
    @media (prefers-reduced-motion: reduce) { #wheel.shake { animation: none; } }
  </style>
</head>
<body>

  <!-- Fond -->
  <canvas id="bg-particles"></canvas>
  <!-- Confettis DERRIÈRE la roue -->
  <canvas id="confetti"></canvas>

  <h2>Tirage des gagnants - <span id="edition">Édition Petit-Terre</span></h2>

  <div id="wheel-container">
    <div id="arrow-container">
      <div class="arrow-border"></div>
      <div class="arrow-core"></div>
    </div>
    <canvas id="wheel" width="400" height="400"></canvas>
    <div id="logo-center"></div>
  </div>

  <button id="spinBtn" disabled>Lancer le tirage</button>

  <h3>Liste des gagnants</h3>
  <div id="winner"></div>

  <script>
    /* ========= Effets visuels : Ciel étoilé ========= */
    (() => {
      const c = document.getElementById('bg-particles');
      if (!c) return;
      const ctx = c.getContext('2d');
      const DPR = Math.min(window.devicePixelRatio || 1, 2);
      let W, H, particles;

      function resize() {
        W = c.width  = innerWidth  * DPR;
        H = c.height = innerHeight * DPR;
        c.style.width  = innerWidth + 'px';
        c.style.height = innerHeight + 'px';
        const count = Math.max(80, Math.min(220, Math.floor((innerWidth*innerHeight)*0.00015)));
        particles = Array.from({length: count}, () => ({
          x: Math.random()*W,
          y: Math.random()*H,
          r: (Math.random()*1.8 + 0.8) * DPR,
          a: Math.random()*Math.PI*2,
          s: Math.random()*0.25 + 0.1
        }));
      }
      addEventListener('resize', resize); resize();

      function tick() {
        ctx.clearRect(0,0,W,H);
        for (const p of particles) {
          p.a += (Math.random()-0.5)*0.02;
          p.x += Math.cos(p.a)*p.s;
          p.y += Math.sin(p.a)*p.s;
          if (p.x<0) p.x+=W; if (p.x>W) p.x-=W;
          if (p.y<0) p.y+=H; if (p.y>H) p.y-=H;
          const twinkle = 0.6 + 0.4 * Math.sin(Date.now()/300 + p.x*0.01 + p.y*0.01);
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
          ctx.fillStyle = `rgba(255,255,255,${0.3 + 0.7*twinkle})`;
          ctx.fill();
        }
        requestAnimationFrame(tick);
      }
      tick();
    })();

    /* ========= Effets visuels : Confettis ========= */
    (() => {
      const canvas = document.getElementById('confetti');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const DPR = Math.min(window.devicePixelRatio || 1, 2);
      let W, H, pieces = [], running = false, rafId = 0;

      function resize() {
        W = canvas.width  = innerWidth  * DPR;
        H = canvas.height = innerHeight * DPR;
        canvas.style.width  = innerWidth + 'px';
        canvas.style.height = innerHeight + 'px';
      }
      addEventListener('resize', resize); resize();

      const COLORS = ['#ffd166','#06d6a0','#118ab2','#ef476f','#ffffff','#a259ff'];

      function addBurst({x, y, count = 140, spread = Math.PI * 1.2, power = 12}) {
        const ox = x * DPR, oy = y * DPR;
        for (let i=0; i<count; i++) {
          const angle = (-Math.PI/2 - spread/2) + Math.random()*spread;
          const speed = (Math.random()*0.6 + 0.4) * power * DPR;
          pieces.push({
            x: ox, y: oy,
            vx: Math.cos(angle)*speed,
            vy: Math.sin(angle)*speed,
            g: 0.25 * DPR, drag: 0.995,
            w: (6 + Math.random()*6) * DPR,
            h: (2 + Math.random()*4) * DPR,
            r: Math.random()*Math.PI, vr: (Math.random()-0.5)*0.3,
            color: COLORS[(Math.random()*COLORS.length)|0],
            life: 90 + (Math.random()*40|0)
          });
        }
        start();
      }

      function start() {
        if (running) return;
        running = true;
        const loop = () => {
          rafId = requestAnimationFrame(loop);
          ctx.clearRect(0,0,W,H);
          for (let i=pieces.length-1; i>=0; i--) {
            const p = pieces[i];
            p.vy += p.g; p.vx *= p.drag; p.vy *= p.drag;
            p.x += p.vx; p.y += p.vy; p.r += p.vr; p.life--;
            const flip = Math.abs(Math.cos(p.r));
            ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.r*0.2);
            ctx.fillStyle = p.color;
            ctx.fillRect(-p.w/2, -p.h*flip/2, p.w, p.h*flip);
            ctx.restore();
            if (p.life <= 0 || p.y > H + 50*DPR) pieces.splice(i,1);
          }
          if (pieces.length === 0) { running = false; cancelAnimationFrame(rafId); }
        };
        loop();
      }

      // Fonction globale pour lancer les confettis
      window.launchConfetti = function(opts = {}) {
        const x = (opts.x ?? innerWidth/2);
        const y = (opts.y ?? innerHeight/3);
        addBurst({x, y, count: opts.count ?? 140, spread: opts.spread ?? Math.PI*1.2, power: opts.power ?? 12});
      };
    })();

    /* =================== ROUE =================== */
    const API_URL = 'https://favelas-production.up.railway.app/api/participants';
    const VILLAGE = null;
    const MAX_WINNERS = 2;

    const canvas = document.getElementById('wheel');
    const ctx = canvas.getContext('2d');
    const radius = canvas.width / 2;

    let participants = [];
    let angleStart = 0;
    let isSpinning = false;
    let winners = [];

    const safeText = (t) => (t || '').toString().trim();

    async function fetchParticipants() {
      try {
        const res = await fetch(API_URL, { headers: { 'Accept': 'application/json' } });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const rows = await res.json();

        const seen = new Set();
        participants = rows
          .filter(r => !VILLAGE || (r.village || '').toLowerCase() === VILLAGE?.toLowerCase())
          .filter(r => {
            const key = safeText(r.pseudo).toLowerCase();
            if (!key || seen.has(key)) return false;
            seen.add(key);
            return true;
          })
          .map(r => ({ pseudo: safeText(r.pseudo), prenom: safeText(r.prenom) }));

        drawWheel();
        document.getElementById('spinBtn').disabled = participants.length < 2;
        if (participants.length < 2) {
          document.getElementById('winner').innerHTML =
            `<p>Pas assez de participants pour lancer le tirage.</p>`;
        }
      } catch (e) {
        console.error('Erreur lors du chargement des participants :', e);
        document.getElementById('winner').innerHTML =
          `<p>Erreur de chargement des participants.</p>`;
      }
    }

    function drawWheel(highlightIndex = null, blinking = false) {
      if (participants.length === 0) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        return;
      }
      const arc = (2 * Math.PI) / participants.length;
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      participants.forEach((p, i) => {
        const angle = angleStart + i * arc;
        const wasWinner = winners.find(w => w.pseudo === p.pseudo);
        const isHighlight = highlightIndex === i;

        if (blinking && isHighlight) {
          const time = Date.now() / 200;
          const flash = Math.floor(time) % 2 === 0 ? '#FFD700' : 'orange';
          ctx.fillStyle = flash;
        } else if (wasWinner) {
          ctx.fillStyle = '#FFD700';
        } else {
          ctx.fillStyle = '#ccc';
        }

        ctx.beginPath();
        ctx.moveTo(radius, radius);
        ctx.arc(radius, radius, radius, angle, angle + arc);
        ctx.lineTo(radius, radius);
        ctx.fill();

        ctx.strokeStyle = '#666';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(radius, radius);
        ctx.lineTo(
          radius + radius * Math.cos(angle),
          radius + radius * Math.sin(angle)
        );
        ctx.stroke();

        ctx.save();
        ctx.translate(radius, radius);
        ctx.rotate(angle + arc / 2);
        ctx.textAlign = 'right';
        ctx.fillStyle = '#000';
        ctx.font = '14px Arial';
        ctx.fillText(p.pseudo, radius - 10, 5);
        ctx.restore();
      });
    }

    function spin() {
      const btn = document.getElementById('spinBtn');
      if (winners.length >= MAX_WINNERS) { btn.disabled = true; return; }
      if (isSpinning || participants.length < 2) return;

      isSpinning = true;

      let winnerIndex;
      do {
        winnerIndex = Math.floor(Math.random() * participants.length);
      } while (winners.find(w => w.pseudo === participants[winnerIndex].pseudo));

      const arc = (2 * Math.PI) / participants.length;
      const stopAngle = (3 * Math.PI) / 2 - (winnerIndex * arc + arc / 2);

      let rotation = 0;
      const duration = 2000;
      const interval = 10;
      const steps = duration / interval;
      const angleStep = (stopAngle + Math.PI * 6) / steps;

      let step = 0;
      const spinInterval = setInterval(() => {
        rotation += angleStep;
        angleStart = rotation;
        drawWheel();
        step++;

        /* Vibration ~400ms avant arrêt (tu avais -120, je conserve pas) */
        if (step === steps - 120) {
          const wheelEl = document.getElementById('wheel');
          wheelEl.classList.add('shake');
          setTimeout(() => wheelEl.classList.remove('shake'), 650);
        }

        if (step >= steps) {
          clearInterval(spinInterval);

          const winner = participants[winnerIndex];
          winners.push(winner);
          document.getElementById('winner').insertAdjacentHTML(
            'beforeend',
            `Gagnant ${winners.length} : <b>${winner.pseudo}</b> (${winner.prenom})<br>`
          );

          // Confettis depuis le centre de la roue
          const wheelBox = document.getElementById('wheel').getBoundingClientRect();
          if (typeof window.launchConfetti === 'function') {
            window.launchConfetti({
              x: wheelBox.left + wheelBox.width / 2,
              y: wheelBox.top  + wheelBox.height / 2,
              power: 20
            });
          }

          let blinkCount = 10;
          const blinkInterval = setInterval(() => {
            drawWheel(winnerIndex, true);
            blinkCount++;
            if (blinkCount >= 6) {
              clearInterval(blinkInterval);
              drawWheel();
            }
          }, 300);

          isSpinning = false;
          if (winners.length >= MAX_WINNERS) btn.disabled = true;
        }
      }, interval);
    }

    document.getElementById('spinBtn').addEventListener('click', spin);
    fetchParticipants();
  </script>
</body>
</html>
