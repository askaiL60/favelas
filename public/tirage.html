<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Roue de tirage</title>
  <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="tirage.css">
</head>
<body>
  <h2>Tirage des gagnants - <span id="edition">Édition Petit-Terre</span></h2>

  <div id="wheel-container">
    <div id="arrow-container">
      <div class="arrow-border"></div>
      <div class="arrow-core"></div>
    </div>

    <canvas id="wheel" width="400" height="400"></canvas>
    <div id="logo-center"></div>
  </div>

  <button id="spinBtn" disabled>Lancer le tirage</button>

  <h3>Liste des gagnants</h3>
  <div id="winner"></div>

  <script>
    const API_URL = 'https://favelas-production.up.railway.app/api/participants_PT';
    const VILLAGE = 'Petit-Terre'; // mettre null pour tous les villages

    const canvas = document.getElementById('wheel');
    const ctx = canvas.getContext('2d');
    const radius = canvas.width / 2;

    let participants = [];
    let angleStart = 0;
    let isSpinning = false;
    let winners = [];

    function safeText(text) { return (text || '').toString().trim(); }

    async function fetchParticipants() {
      try {
        const res = await fetch(API_URL, { headers: { 'Accept': 'application/json' } });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const rows = await res.json();

        // Filtre + dédoublonnage
        const seen = new Set();
        participants = rows
          .filter(r => !VILLAGE || r.village === VILLAGE)
          .filter(r => {
            const key = safeText(r.pseudo).toLowerCase();
            if (!key || seen.has(key)) return false;
            seen.add(key);
            return true;
          })
          .map(r => ({ pseudo: safeText(r.pseudo), prenom: safeText(r.prenom) }));

        drawWheel();
        document.getElementById('spinBtn').disabled = participants.length < 1;

        if (participants.length < 2) {
          console.warn('Pas assez de participants pour un tirage.');
        }
      } catch (e) {
        console.error('Erreur lors du chargement des participants :', e);
        alert('Impossible de charger la liste des participants.');
      }
    }

    function drawWheel(highlightIndex = null, blinking = false) {
      if (participants.length === 0) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        return;
      }

      const arc = 2 * Math.PI / participants.length;
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      participants.forEach((p, i) => {
        const angle = angleStart + i * arc;
        const isWinner = winners.find(w => w.pseudo === p.pseudo);
        const isHighlight = highlightIndex === i;

        if (blinking && isHighlight) {
          const time = Date.now() / 200;
          const flash = Math.floor(time) % 2 === 0 ? "#FFD700" : "orange";
          ctx.fillStyle = flash;
        } else if (isWinner) {
          ctx.fillStyle = "#FFD700";
        } else {
          ctx.fillStyle = "#ccc";
        }

        // segment
        ctx.beginPath();
        ctx.moveTo(radius, radius);
        ctx.arc(radius, radius, radius, angle, angle + arc);
        ctx.lineTo(radius, radius);
        ctx.fill();

        // séparateur
        ctx.strokeStyle = "#666";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(radius, radius);
        ctx.lineTo(
          radius + radius * Math.cos(angle),
          radius + radius * Math.sin(angle)
        );
        ctx.stroke();

        // texte pseudo
        ctx.save();
        ctx.translate(radius, radius);
        ctx.rotate(angle + arc / 2);
        ctx.textAlign = "right";
        ctx.fillStyle = "#000";
        ctx.font = "14px Arial";
        ctx.fillText(p.pseudo, radius - 10, 5);
        ctx.restore();
      });
    }

    function spin() {
      if (isSpinning || participants.length < 1) return;

      isSpinning = true;
      let winnerIndex;

      do {
        winnerIndex = Math.floor(Math.random() * participants.length);
      } while (winners.find(w => w.pseudo === participants[winnerIndex].pseudo));

      const arc = 2 * Math.PI / participants.length;
      const stopAngle = 3 * Math.PI / 2 - (winnerIndex * arc + arc / 2);

      let rotation = 0;
      const duration = 2000;
      const interval = 10;
      const steps = duration / interval;
      const angleStep = (stopAngle + Math.PI * 6) / steps;

      let step = 0;
      const spinInterval = setInterval(() => {
        rotation += angleStep;
        angleStart = rotation;
        drawWheel();
        step++;
        if (step >= steps) {
          clearInterval(spinInterval);
          const winner = participants[winnerIndex];
          winners.push(winner);
          document.getElementById('winner').innerHTML +=
            `Gagnant ${winners.length} : <b>${winner.pseudo}</b> (${winner.prenom})<br>`;

          // clignotement
          let blinkCount = 0;
          const blinkInterval = setInterval(() => {
            drawWheel(winnerIndex, true);
            blinkCount++;
            if (blinkCount >= 6) {
              clearInterval(blinkInterval);
              drawWheel();
            }
          }, 300);

          isSpinning = false;
        }
      }, interval);
    }

    document.getElementById('spinBtn').addEventListener('click', spin);

    fetchParticipants();
  </script>
</body>
</html>
